---
title: "AMR Analysis"
author: "Emily Bean"
date: "March 12, 2020"
output: 
  rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = "center")

require(dplyr)
require(tidyr)
require(stringr)
require(ggplot2)

# read in data
counts <- read.table("https://github.com/EmilyB17/amr-brazil/blob/master/data/parsedRelativeAbundanceNoContams.txt?raw=true", sep = "\t", header = TRUE)

# get unique factors for loops
classes <- unique(counts$broadclass)
types <- unique(counts$type)
proteins <- unique(counts$protein)
genes <- unique(counts$gene)
patterns <- unique(counts$pattern)

```

## Analysis Structure

**Comparisons**  

Pairwise comparisons between Farm 1 and Farm 2.  
Comparisons between body sites (rumen, feces, nasal swab) at each farm.  

MEGARES database categories include: type of resistance, resistance class within type (i.e. type of drug within Drug resistance), protein class, and gene. Pairwise comparisons can be made for all of these but it seems to make the most biological sense to compare genes, protein classes, and resistance classes.  

***

Therefore, here is the proposed comparison structure:  
Genes: Farm 1 vs Farm 2  
Proteins: Farm 1 vs Farm 2  
Resistance class: Farm 1 vs Farm 2  
**Wilcox Rank Sum test**

Genes: SNP vs Rumen vs Feces (Farm 1 and Farm 2)  
Proteins: SNP vs Rumen vs Feces (Farm 1 and Farm 2)  
Resistance class: SNP vs Rumen vs Feces (Farm 1 and Farm 2)  
**Kruskal Wallis test**

***


### Data Exploration  

```{r}

# in the entire dataset, there are 174 unique proteins in 3 classes
exp <- counts %>% 
  group_by(broadclass, type, protein) %>% 
  summarize()

# show unique proteins
knitr::kable(exp)
```

```{r}

# data is not normally distributed and is very zero-skewed
hist(counts$relabun, main = "Histogram of Relative Abundance",
     xlab = "Relative abundance", ylab = "Frequency")

```

### Pairwise comparisons between farms

Wilcox Rank-Sum test for non-parametric pairwise test of relative abundnace between farms

**Genes**
```{r}

# Wilcox rank-sum for pairwise differences between farms

# create empty df to fill in the loop
outsig <- data.frame()
# loop through all 666 genes
for(i in 1:length(patterns)) {
  
  # perform wilcox test
  w <- wilcox.test(relabun ~ farm, data = filter(counts, pattern == patterns[i]),
                   exact = FALSE)
  
  # get output p value
  outsig[i, "pattern"] <- patterns[i]
  outsig[i, "pval"] <- round(w$p.value, 3)
  
}

# adjust p values for false discovery rate
adj <- outsig %>% 
  mutate(
    # adjust p values with FDR
    padj = p.adjust(pval, method = "fdr", n = length(outsig$pval)),
    # Boolean for significance
    sig = case_when(
      padj < 0.05 ~ TRUE,
      padj >= 0.05 ~ FALSE))

# get only significant variables and add median + IQR
sigs <- adj %>% 
  filter(sig == "TRUE") %>% 
  left_join(counts, by = "pattern") %>% 
  group_by(farm, pattern, broadclass, type, protein, gene) %>% 
  summarize(median = median(relabun),
            IQR = IQR(relabun)) %>% 
  ungroup() %>% 
  mutate(farm = factor(farm))

```

There are `r length(unique(sigs$pattern))` genes that are significantly different between farms, which is difficult to visualize. 

This plot shows all genes between farms; most decrease from farm 1 to farm 2.

```{r}

# visualize the major trends
ggplot(data = sigs, aes(x = farm, y = median, group = gene)) +
  geom_point() +
  geom_jitter() +
  geom_line() +
  theme_bw() +
  labs(x = "Farm", y = "Median Relative Abundance") +
  ggtitle("Significantly different genes by farm",
          subtitle = paste0("n = (", length(which(adj$sig == TRUE)), ")"))

```


**Proteins**

```{r}

outsig <- data.frame()
for(i in 1:length(proteins)) {
  
  w <- wilcox.test(relabun ~ farm, data = filter(counts, protein == proteins[i]),
                   exact = FALSE)
  
  outsig[i, "protein"] <- proteins[i]
  outsig[i, "pval"] <- round(w$p.value, 3)
  
}

# adjust p values for false discovery rate
adj <- outsig %>% 
  mutate(
    # adjust p values with FDR
    padj = p.adjust(pval, method = "fdr", n = length(outsig$pval)),
    # Boolean for significance
    sig = case_when(
      padj < 0.05 ~ TRUE,
      padj >= 0.05 ~ FALSE))

# get only significant variables and add median + IQR
sigs <- adj %>% 
  filter(sig == "TRUE") %>% 
  left_join(counts, by = "protein") %>% 
  group_by(farm, broadclass, type, protein) %>% 
  summarize(median = median(relabun),
            IQR = IQR(relabun)) %>% 
  ungroup() %>% 
  mutate(farm = factor(farm))

```

There are `r length(unique(sigs$protein))` significantly different resistance proteins; the plot shows that most are only present in one of the two farms.

```{r}

# visualize the major trends
ggplot(data = sigs, aes(x = farm, y = median, group = protein)) +
  geom_point() +
  geom_jitter() +
  geom_line() +
  theme_bw() +
  labs(x = "Farm", y = "Median Relative Abundance") +
  ggtitle("Significantly different proteins by farm",
          subtitle = paste0("n = (", length(which(adj$sig == TRUE)), ")"))

```

**Resistance Type**

```{r}

outsig <- data.frame()
for(i in 1:length(types)) {
  
  w <- wilcox.test(relabun ~ farm, data = filter(counts, type == types[i]),
                   exact = FALSE)
  
  outsig[i, "type"] <- types[i]
  outsig[i, "pval"] <- round(w$p.value, 3)
  
}

# adjust p values for false discovery rate
adj <- outsig %>% 
  mutate(
    # adjust p values with FDR
    padj = p.adjust(pval, method = "fdr", n = length(outsig$pval)),
    # Boolean for significance
    sig = case_when(
      padj < 0.05 ~ TRUE,
      padj >= 0.05 ~ FALSE))

# get only significant variables and add median + IQR
sigs <- adj %>% 
  filter(sig == "TRUE") %>% 
  left_join(counts, by = "type") %>% 
  group_by(farm, broadclass, type) %>% 
  summarize(median = median(relabun),
            IQR = IQR(relabun)) %>% 
  ungroup() %>% 
  mutate(farm = factor(farm))


```

There are `r length(unique(sigs$type))` significantly different resistance types; again, the plot shows that most are only present in one of the two farms.

```{r}

# visualize the major trends
ggplot(data = sigs, aes(x = farm, y = median, group = type)) +
  geom_point() +
  geom_jitter() +
  geom_line() +
  theme_bw() +
  labs(x = "Farm", y = "Median Relative Abundance") +
  ggtitle("Significantly different types by farm",
          subtitle = paste0("n = (", length(which(adj$sig == TRUE)), ")"))

```



### Comparisons between body sites

Kruskal-Wallis test for non-parametric comparisons between the 3 body sites, stratified by farm.

**Genes**

```{r}


## Stratify for each farm
counts <- counts %>% mutate(farm = factor(farm))
farms <- levels(counts$farm)
# create empty dataframe to fill within the loop
outsig <- data.frame()

for(j in 1:length(farms)) {
  
  # iterate through all 666 genes
  for(i in 1:length(patterns)) {
    
    # perform Kruskal-Wallis test
    k <- kruskal.test(relabun ~ site, data = filter(counts, pattern == patterns[i] &
                                                      farm == farms[j]))
    
   
    # some farms do not have the gene present; mark as 'absent'
    if(is.na(k$p.value)) {
      
      pvaldat <- NA
      
    } else {
      
      pvaldat <- round(k$p.value, 3)
      
    } 
        
    # collect variables to output DF
    outsig <- rbind(outsig,
                    data.frame(farm = farms[j],
                               pattern = patterns[i],
                               pval = pvaldat))
  }
}

# adjust p vals for multiple comparisons with false discovery rate
adj <- outsig %>% 
  mutate(
    # adjust p values with FDR
    padj = p.adjust(pval, method = "fdr", n = length(outsig$pval)),
    # Boolean for significance
    sig = case_when(
      padj < 0.05 ~ TRUE,
      padj >= 0.05 ~ FALSE))
 
# get genes that had a significant difference
sigs <- adj %>% filter(sig == "TRUE") %>%  
  left_join(counts, by = c("pattern", "farm")) %>% 
  group_by(site, broadclass, farm, pattern) %>% 
  summarize(median = median(relabun),
            IQR = IQR(relabun)) %>% 
  ungroup() %>% 
  mutate(site = factor(site),
         farm = factor(farm))

```

There are `r length(unique(sigs$pattern))` significant genes between body sites.

This plot visualizes the differences; most are higher in feces, then rumen, then SNP. However, one gene is higher in SNP.

```{r}

# visualize the major trends
ggplot(data = sigs, aes(x = site, y = median, group = pattern)) +
  geom_point() +
  geom_jitter() +
  geom_line() +
  theme_bw() +
  labs(x = "Body Site", y = "Median Relative Abundance") +
  ggtitle("Significantly different genes by site & farm",
          subtitle = paste0("n = (", length(which(adj$sig == TRUE)), ")")) +
  facet_wrap(~ farm)

```


**Proteins**

```{r}

## Stratify for each farm
counts <- counts %>% mutate(farm = factor(farm))
farms <- levels(counts$farm)
# create empty dataframe to fill within the loop
outsig <- data.frame()

for(j in 1:length(farms)) {
  
  # iterate through all 666 genes
  for(i in 1:length(proteins)) {
    
    # perform Kruskal-Wallis test
    k <- kruskal.test(relabun ~ site, data = filter(counts, protein == proteins[i] &
                                                      farm == farms[j]))
    
   
    # some farms do not have the gene present; mark as 'absent'
    if(is.na(k$p.value)) {
      
      pvaldat <- NA
      
    } else {
      
      pvaldat <- round(k$p.value, 3)
      
    } 
        
    # collect variables to output DF
    outsig <- rbind(outsig,
                    data.frame(farm = farms[j],
                               protein = proteins[i],
                               pval = pvaldat))
  }
}

# adjust p vals for multiple comparisons with false discovery rate
adj <- outsig %>% 
  mutate(
    # adjust p values with FDR
    padj = p.adjust(pval, method = "fdr", n = length(outsig$pval)),
    # Boolean for significance
    sig = case_when(
      padj < 0.05 ~ TRUE,
      padj >= 0.05 ~ FALSE))
 
# get genes that had a significant difference
sigs <- adj %>% filter(sig == "TRUE") %>%  
  left_join(counts, by = c("protein", "farm")) %>% 
  group_by(site, broadclass, type, farm, protein) %>% 
  summarize(median = median(relabun),
            IQR = IQR(relabun)) %>% 
  ungroup() %>% 
  mutate(site = factor(site),
         farm = factor(farm))


```

```{r}

# visualize the major trends
ggplot(data = sigs, aes(x = site, y = median, group = protein)) +
  geom_point() +
  geom_jitter() +
  geom_line() +
  theme_bw() +
  labs(x = "Body Site", y = "Median Relative Abundance") +
  ggtitle("Significantly different proteins by site & farm",
          subtitle = paste0("n = (", length(which(adj$sig == TRUE)), ")")) +
  facet_wrap(~ farm)

```


**Resistance Type**

```{r}


## Stratify for each farm
counts <- counts %>% mutate(farm = factor(farm))
farms <- levels(counts$farm)
# create empty dataframe to fill within the loop
outsig <- data.frame()

for(j in 1:length(farms)) {
  
  # iterate through all 666 genes
  for(i in 1:length(types)) {
    
    # perform Kruskal-Wallis test
    k <- kruskal.test(relabun ~ site, data = filter(counts, type == types[i] &
                                                      farm == farms[j]))
    
   
    # some farms do not have the gene present; mark as 'absent'
    if(is.na(k$p.value)) {
      
      pvaldat <- NA
      
    } else {
      
      pvaldat <- round(k$p.value, 3)
      
    } 
        
    # collect variables to output DF
    outsig <- rbind(outsig,
                    data.frame(farm = farms[j],
                               type = types[i],
                               pval = pvaldat))
  }
}

# adjust p vals for multiple comparisons with false discovery rate
adj <- outsig %>% 
  mutate(
    # adjust p values with FDR
    padj = p.adjust(pval, method = "fdr", n = length(outsig$pval)),
    # Boolean for significance
    sig = case_when(
      padj < 0.05 ~ TRUE,
      padj >= 0.05 ~ FALSE))
 
# get genes that had a significant difference
sigs <- adj %>% filter(sig == "TRUE") %>%  
  left_join(counts, by = c("type", "farm")) %>% 
  group_by(site, broadclass, type, farm) %>% 
  summarize(median = median(relabun),
            IQR = IQR(relabun)) %>% 
  ungroup() %>% 
  mutate(site = factor(site),
         farm = factor(farm))
```


```{r}

# visualize the major trends
ggplot(data = sigs, aes(x = site, y = median, group = type)) +
  geom_point() +
  geom_jitter() +
  geom_line() +
  theme_bw() +
  labs(x = "Body Site", y = "Median Relative Abundance") +
  ggtitle("Significantly different proteins by site & farm",
          subtitle = paste0("n = (", length(which(adj$sig == TRUE)), ")")) +
  facet_wrap(~ farm)

```

